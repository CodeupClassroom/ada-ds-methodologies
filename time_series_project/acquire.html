<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>acquire.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>acquire.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <h1>Data Acquisition</h1>
<ol>
<li>Planning</li>
<li><strong>Data Acquisition</strong> &lt;- You are here</li>
<li>Data Preparation</li>
<li>Data Exploration</li>
<li>Data Modeling</li>
</ol>
<p>This script provides functions for downloading the data from the server and
processing it.</p>
<h2>Overview</h2>
<p>We get the data as a <a href="https://en.wikipedia.org/wiki/Gzip">gzipped</a> <a href="https://en.wikipedia.org/wiki/Tar_(computing)">tar
archive</a>, which means that
while the data consists of multiple files, we download it as a single file.
This script will uncompress the data and split it into multiple files.</p>
<p>The resulting files are data from fitbit, and each file represents about 30
days worth of data. Each file has activity and nutrition data in it.</p>
<p>While the files have the <code>csv</code> file extension, they are not yet ready to work
with. Each file consists of multiple sections (which should ideally be
separate csv files), separated by blank lines. Each section consists of:</p>
<ul>
<li>a title, a single line describing the section. These are consistent between
  the different files, e.g. each csv file has a &ldquo;Foods&rdquo; section</li>
<li>a header row</li>
<li>the data itself</li>
</ul>
<p>The sections present in each file are:</p>
<ul>
<li>Foods</li>
<li>Activites</li>
<li>Multiple sections indicating nutrition data for individual days</li>
</ul>
<p>This script will combine all of the various sections together into two
resulting csv files: <code>Foods.csv</code> and <code>Activities.csv</code>, which will be loaded
as data frames when the <code>get_fitbit_data</code> function is called.</p>
<p>We are ignoring the indiviual day food logs, which might be a place for
further future exploration.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h2>Implementation</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p><code>log</code> is a simple little function to help us with out logging output. It will
prepend a timestamp and the name of the file to any passed messages.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;[{datetime.now()} acquire.py] {msg}&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p><code>Section</code> is a type to represent the sections of the &ldquo;csv&rdquo; files that we get
from fitbit.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">Section</span> <span class="o">=</span> <span class="n">NamedTuple</span><span class="p">(</span><span class="s1">&#39;Section&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]),</span>
                                 <span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])])</span>

<span class="n">DATA_URL</span> <span class="o">=</span> <span class="s1">&#39;https://ds.codeup.com/fitbit-data.tar.gz&#39;</span>
<span class="n">TGZ_FILE_PATH</span> <span class="o">=</span> <span class="s1">&#39;./fitbit-data.tar.gz&#39;</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s1">&#39;./fitbit&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">process_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Section</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a section as a big string, will extract the pieces and return a</span>
<span class="sd">    Section object.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">title</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Section</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_sections</span><span class="p">(</span><span class="n">fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Section</span><span class="p">]:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a filepath, will return a list of the sections in that file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Sections are separated by empty lines, or <code>\n\n</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="p">[</span><span class="n">process_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">download_data</span><span class="p">():</span>
    <span class="s1">&#39;Download the compressed data from the server&#39;</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Downloading data file&#39;</span><span class="p">)</span>
    <span class="n">filepath</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlretrieve</span><span class="p">(</span><span class="n">DATA_URL</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">TGZ_FILE_PATH</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">extract_data</span><span class="p">():</span>
    <span class="s1">&#39;Untar and uncompress the data&#39;</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Extracting files&#39;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">unpack_archive</span><span class="p">(</span><span class="n">TGZ_FILE_PATH</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">process_data_and_save_csvs</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Run through all the extracted data and put it into a more reasonable format,</span>
<span class="sd">    two output csvs.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Processing data&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>We&rsquo;ll start by getting a list of the sections in each file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">csvfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;{DATA_DIR}/{file}&#39;</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)]</span>
    <span class="n">processed_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_sections</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">csvfiles</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>We want to put all the same sections together from each file, e.g. all the
food sections should go together. We will use this dictionary to do so.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Foods&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Activities&#39;</span><span class="p">:</span> <span class="p">[]}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>After a quick look at the data, we&rsquo;ll just take a look at the <code>Foods</code> and
<code>Activites</code> sections. We can always come back later and look at the other
sections.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Loop through all of the processed sections and put the sections into the
appropriate place in the output dictionary.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">processed_files</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">output</span><span class="p">[</span><span class="n">section</span><span class="o">.</span><span class="n">title</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Combine all the sections into one big csv file for each group.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">group</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>The first line of the output csv should be the columns, and the rest
of the lines will be the data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">csv_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">csv_contents</span> <span class="o">+=</span> <span class="n">section</span><span class="o">.</span><span class="n">data</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">group</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csv_contents</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_fitbit_data</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the foods and activites data as data frames.</span>

<span class="sd">    By default this will use local csv files if they exist.</span>

<span class="sd">    To force a re-download and re-processing of the data, use cache=False</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;Foods.csv&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;Activities.csv&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">download_data</span><span class="p">()</span>
        <span class="n">extract_data</span><span class="p">()</span>
        <span class="n">process_data_and_save_csvs</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Reading data from local csvs&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Foods.csv&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Activities.csv&#39;</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
